<html>
<head>
<title>FBX Importer</title>
<script>

  var ready = true;
  var log = "";

function encode(txt)
  {
    var len = txt.length;
    var data = [];
    var j = 0;
    var linecomment = false;
    var blockcomment = false;
    var space = false;
    var skip = 0;
    for (var i = 0; i < len; ++i) {
/*
      if (blockcomment) { if (txt.charAt(i) == '*' && txt.charAt(i + 1) == '/') blockcomment = false; ++i; continue; }
      if (linecomment) { if (txt.charAt(i) == '\n') linecomment = false; continue; }
      if (txt.charAt(i) == '/' && txt.charAt(i + 1) == '/') { linecomment = true; continue; }
      else if (txt.charAt(i) == '/' && txt.charAt(i + 1) == '*') { blockcomment = true; continue; }
      if (txt.charAt(i) == ' ') { if (!space) space = true; else continue; }
      else if (space) space = false;
*/
      data[j++] = (txt.charCodeAt(i));
      ++skip;
      if (skip == 3) { skip = 0; data[j++] = 255; }
    }
    data[j++] = 0;
    ++skip;
    if (skip == 3) { skip = 0; data[j++] = 255; }

    // load all image data
    var img = document.createElement('canvas'); // document.getElementById('surface');
    var width = (Math.sqrt(j / 4) | 0) + 1;
    for (var i = j; i < width * width * 4; ++i) data[i] = 0;

    img.width = width;
    img.height = width;
    var context = img.getContext('2d');
    var map = context.createImageData(width, width);
    map.data.set(data);
    context.putImageData(map, 0, 0, 0, 0, width, width);

    var save = document.getElementById('save');
    save.src = img.toDataURL("image/png");

    ready = true;
  }

function load()
{
  if (!ready) return;
  ready = false;
  var sdiv = document.getElementById("state");
  sdiv.innerHTML = "Please wait... processing.";

  var div = document.getElementById("error");
  div.innerHTML = "";
  var save = document.getElementById('save');
  save.src = "";

  var file = document.getElementById("file").value;
  var client = new XMLHttpRequest();
  client.open('GET', file);
  client.responseType = "arraybuffer";
  client.onload = function() { process(client.response); }
  client.send();
}

function fromWorker(oEvent)
{
  if (!oEvent.data.type) return;
  if (oEvent.data.type == 1)  // result
  {
    var sdiv = document.getElementById("state");
    sdiv.innerHTML = "Please wait... encoding.";
    encode(oEvent.data.result);
    sdiv.innerHTML = "Done.";
  }
  else if (oEvent.data.type == 2)  // message
  {
    error(oEvent.data.result);
  }
};

function error(msg)
{
  var div = document.getElementById("error");
  log += msg + "\n";
  if (show) div.innerHTML = log;
  console.log(msg);
}

function process(text)
{
  var str = new Uint8Array(text);

  var myWorker;
  if (str[0] == 59)
  {
    text = "";
    var len = str.length;
    for (var i = 0; i < len; ++i) text += String.fromCharCode(str[i]);
    //    text = String.fromCharCode.apply(null, str);
    myWorker = new Worker("fbxload.worker.js");
  }
  else
    myWorker = new Worker("fbxload.bin.worker.js");
  myWorker.onmessage = fromWorker;
  myWorker.postMessage(text);
}

var show = false;

function toggle()
{
  var div = document.getElementById("error");
  if (show)
  {
    show = false;
    div.innerHTML = "";
  }
  else
  {
    div.innerHTML = log;
    show = true;
  }

}
</script>
</head>
<body>

ASCII FBX Mesh file (2013 format): <input id="file"></input>
<input type=button onClick="load();" value="Load"></input><br>
<input type="checkbox" id="uvs" checked />UVs
<input type="checkbox" id="normals" checked />Normals
<input type="checkbox" id="tangets"  />Tangents
<input type="checkbox" id="binormals"  />Binormals<br />
<input type="checkbox" id="animations"  />Animations<br />
<br />
<div id="state"></div><br />
Processing log: <input type=button onClick="toggle();" value="Toggle"></input>  <br>
<pre><div id="error"></div></pre>  <br />
Result: <br />
<div><image id='save'></div><br />
  <pre>
FBX importer

TODO: 
- material texture filename?
- frames and such
- animations
</pre>

</body>
</html>
